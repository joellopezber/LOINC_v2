<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Ontology Service</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/test-styles.css">
</head>
<body>
    <div class="container">
        <a href="/tests/index.html" class="back-link">‚Üê Volver a Tests</a>
        <h1>Test Ontology Service</h1>
        
        <div class="status-section">
            <div class="status-item">
                <span class="status-label">Estado WebSocket:</span>
                <span id="connectionStatus" class="connectionStatus disconnected">Desconectado</span>
            </div>
            <div class="status-item">
                <span class="status-label">Installation Time:</span>
                <span id="installTimeDisplay">Cargando...</span>
            </div>
        </div>

        <div class="search-container">
            <input type="text" id="searchInput" class="input" placeholder="Introduce un t√©rmino m√©dico..." />
            <button id="searchButton" class="button">Analizar</button>
        </div>

        <div id="results" class="results">
            <div id="termSection" class="section">
                <div class="section-title">T√©rmino en ingl√©s</div>
                <div id="termInEnglish"></div>
            </div>

            <div id="relatedSection" class="section">
                <div class="section-title">T√©rminos relacionados</div>
                <div id="relatedTerms" class="tag-list"></div>
            </div>

            <div id="testSection" class="section">
                <div class="section-title">Tipos de pruebas</div>
                <div id="testTypes" class="tag-list"></div>
            </div>

            <div id="loincSection" class="section">
                <div class="section-title">C√≥digos LOINC</div>
                <div id="loincCodes" class="tag-list"></div>
            </div>

            <div id="keywordSection" class="section">
                <div class="section-title">Palabras clave</div>
                <div id="keywords" class="tag-list"></div>
            </div>

            <div class="section">
                <div class="section-title">Respuesta JSON completa</div>
                <pre id="jsonViewer" class="json-viewer"></pre>
            </div>
        </div>
    </div>

    <!-- Scripts necesarios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script type="module">
        import { OntologyTester } from '../js/ontology.js';

        // Referencias DOM
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const resultsContainer = document.getElementById('results');
        const connectionStatus = document.getElementById('connectionStatus');

        // Inicializar Ontology Tester
        const tester = new OntologyTester();

        // Configurar callbacks
        tester.onConnectionChange = (isConnected) => {
            connectionStatus.className = isConnected ? 'connected' : 'disconnected';
            connectionStatus.textContent = isConnected ? 'Conectado' : 'Desconectado';
            searchInput.disabled = !isConnected;
            searchButton.disabled = !isConnected;
        };

        tester.onSearchResult = (results) => {
            displayResults(results);
        };

        tester.onError = (error) => {
            displayError(error.message);
        };

        // Funci√≥n para mostrar resultados
        function displayResults(data) {
            resultsContainer.classList.add('visible');
            console.log('Datos recibidos:', data);

            if (!data) {
                displayError('Respuesta inv√°lida del servidor');
                return;
            }

            const {
                term_in_english = '',
                related_terms = [],
                test_types = [],
                loinc_codes = {},
                keywords = []
            } = data;

            // Mostrar t√©rmino en ingl√©s
            document.getElementById('termInEnglish').textContent = term_in_english;

            // Mostrar t√©rminos relacionados
            const relatedTerms = document.getElementById('relatedTerms');
            relatedTerms.innerHTML = related_terms.map(term => 
                `<span class="tag">${term}</span>`
            ).join('');

            // Mostrar tipos de pruebas
            const testTypes = document.getElementById('testTypes');
            testTypes.innerHTML = test_types.map(type => 
                `<span class="tag">${type}</span>`
            ).join('');

            // Mostrar c√≥digos LOINC
            const loincCodes = document.getElementById('loincCodes');
            loincCodes.innerHTML = Object.entries(loinc_codes).map(([key, code]) => 
                `<div class="loinc-code">
                    <span class="code">${code.code}</span>
                    <div class="loinc-details">
                        <div>Component: ${code.component}</div>
                        <div>Property: ${code.property}</div>
                        <div>Time: ${code.time}</div>
                        <div>System: ${code.system}</div>
                        <div>Scale: ${code.scale}</div>
                        ${code.method ? `<div>Method: ${code.method}</div>` : ''}
                    </div>
                </div>`
            ).join('');

            // Mostrar palabras clave
            const keywordsElement = document.getElementById('keywords');
            keywordsElement.innerHTML = keywords.map(keyword => 
                `<span class="tag">${keyword}</span>`
            ).join('');

            // Mostrar JSON completo
            document.getElementById('jsonViewer').textContent = 
                JSON.stringify(data, null, 2);
        }

        // Funci√≥n para mostrar errores
        function displayError(message) {
            resultsContainer.classList.add('visible');
            resultsContainer.innerHTML = `<div class="error">${message}</div>`;
        }

        // Manejar b√∫squeda
        async function handleSearch() {
            const query = searchInput.value.trim();
            if (!query) return;

            try {
                searchInput.disabled = true;
                searchButton.disabled = true;
                resultsContainer.classList.remove('visible');

                await tester.search(query);
            } catch (error) {
                console.error('Error al buscar:', error);
                displayError(error.message);
            } finally {
                searchInput.disabled = false;
                searchButton.disabled = false;
            }
        }

        // Event listeners
        searchButton.addEventListener('click', handleSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSearch();
            }
        });

        // Conectar al iniciar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Iniciando aplicaci√≥n...');
            const installTime = localStorage.getItem('installTimestamp') || 'No disponible';
            document.getElementById('installTimeDisplay').textContent = installTime;
            console.log('‚è∞ Installation Time:', installTime);
            tester.connect();
        });
    </script>
</body>
</html> 